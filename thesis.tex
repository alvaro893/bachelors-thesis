%----------------------------------------------------------------------------------------
%	TITLE PAGE CONFIGURATION
%----------------------------------------------------------------------------------------

\def\thesislang{english} %change this depending on your language
\author{Álvaro Bolaños Rodríguez}
\def\thesis{Opinnäytetyö/Thesis}
\def\alaotsikko{Creating a cloud based communication channel}

%Finnish section
\def\otsikko{Opinnäytetyön otsikko}
\def\tutkinto{Tutkinto}
\def\kohjelma{Koulutusohjelma}
\def\suuntautumis{Suuntautumisvaihtoehto}
\def\ohjaajat{
Etunimi Sukunimi, Titteli\newline
Etunimi Sukunimi, Titteli
}
\def\avainsanat{avainsanat}
\def\pvm{\specialdate\today}

%English section, for abstract
\title{IR camera in Well-being technology}
\def\metropoliadegree {Bachelor of Engineering}
\def\metropoliadegreeprogramme {Information Technology}
\def\metropoliaspecialisation {Software Engineer}
\def\metropoliainstructors {
Name, Title \newline
}
\def\metropoliakeywords {Keywords}
\date{\today}

%----------------------------------------------------------------------------------------
%	GLOBAL STYLES
%----------------------------------------------------------------------------------------

\documentclass[hidelinks,11pt,a4paper,oneside,article]{memoir}
\usepackage[\thesislang]{babel} 
\usepackage{iflang}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{fontspec}
\usepackage{tocloft}
\usepackage{titlesec}
\usepackage[hyphens]{url}
\usepackage{mathtools}
\usepackage{wallpaper}
\usepackage{datetime}
\usepackage[bookmarksdepth=subsection]{hyperref} % for automagic pdf links for toc, refs, etc.
\usepackage[amssymb]{SIunits}
\usepackage[version=3]{mhchem}
\usepackage{pgfplots} %simple plots etc
\usepackage{pgfplotstable}
\usepackage{tikz} % mindmaps, flowcharts, piecharts, examples at http://www.texample.net/tikz/examples/
\usepackage{csquotes}
\usepackage{xparse}
\usepackage{tabu}
\usetikzlibrary{shapes.geometric, arrows}
%\numberwithin{equation}{chapter} % this add the chapter in the equation



\renewcommand{\dateseparator}{.}
%condition for adding or not space in TOC
\usepackage{etoolbox}
%for compact list
\usepackage{enumitem}
%for block comment
\usepackage{verbatim}
%for "easier" references
\usepackage{varioref}
%forcing single line spacing in bibliography
\DisemulatePackage{setspace}
\usepackage{setspace}
%including figure (image)
\usepackage{graphicx}
%change the numbering for figure
\usepackage{chngcntr}
%strike trough
\usepackage{ulem}
%euro symbol
\usepackage{eurosym}
%try to count
\usepackage{totcount}
%insert source code
\usepackage{listings}
\usepackage[justification=centering,singlelinecheck=false]{caption}
\usepackage{color}
%force the width of a table instead of column
\usepackage{tabularx}
\usepackage{booktabs} %why not booktabs? :3
% Abbreviations, acronym and glossary
\usepackage[acronym,nonumberlist,section]{glossaries}%xindy,%toc, ,nomain

\usepackage{float} % For forced figure location with modifier H (\begin{figure}[H])
\usepackage{cite} % Make citations to match Metropolia thesis guide

% change font of links in bibliography to same as other text
\usepackage{url}
\urlstyle{same}

% change punctuation of multiple cites to semicolon instead of comma: [1; 2; 3]
\renewcommand\citepunct{; }

% citep-macro for reference with period inside square brackets [1.]
\newcommand{\citep}[1]{
 \renewcommand\citeright{.]}
 \cite{#1}
 \renewcommand\citeright{]}
}

%set date format to D.M.YYYY
\newdateformat{specialdate}{\THEDAY.\THEMONTH.\THEYEAR}

\newcommand\tn[1]{\textnormal{#1}} %use \tn instead of \textnormal
\newcommand\reaction[1]{\begin{equation}\ce{#1}\end{equation}} %\reaction{} for chemical reactions

%----------------------------------------------
% CUSTOM COMMANDS
%----------------------------------------------
\newcommand{\putimage}[3][10] %[3]: 3 parameters, [10] default value for 1st parameter is 10
{
\begin{figure}[h]
	\centering
	\captionsetup{justification=centering}
	\includegraphics[width=#1cm]{#2}
	\caption{#3}
	\label{fig:#2}
\end{figure}
}
% idea for this command from http://tex.stackexchange.com/questions/25597/wrapping-code-listings-verbatim-or-other-method-inside-a-newcommand
\ExplSyntaxOn
\NewDocumentCommand{\putcode}{m m O{} +v }
{
	\begin{figure}[h]
%		\centering
%		\captionsetup{justification=centering}
		 \newlinechar=\endlinechar
		 \exp_args:Nx \scantokens
		 {
		 	\string\begin{lstlisting}[caption={#2},label={listing:#1},\unexpanded{#3}]
		 	#4
		 	\string\end{lstlisting}
		 }

%		\caption{#2}
%		\label{fig:#1}
	\end{figure}\vspace{-17pt}
}
\ExplSyntaxOff


%NORMAL TEXT
%all text, title, etc. in the same font: Arial
%replace with arial.ttf if you have the fontfile
\setmainfont
[BoldFont=LiberationSans-Bold.ttf,
ItalicFont=LiberationSans-Italic.ttf,
BoldItalicFont=LiberationSans-BoldItalic.ttf]
{LiberationSans-Regular.ttf}
%line space
\linespread{1.5}
%\doublespacing
%margin
\usepackage[top=2.5cm, bottom=3cm, left=4cm, right=2cm, nofoot]{geometry}
\setlength{\parindent}{0pt} %first line of paragraph not indented
\setlength{\parskip}{16.5pt} %one empty line to separate paragraph
%list with small line space separation
\tightlists

%IMAGE - FIGURE
%the figures should be placed in the "illustration" folder
\graphicspath{{illustration/}}
%figure number without chapter (1.1, 1.2, 2.1) to (1, 2, 3)
\counterwithout{figure}{chapter}
%border around images
\setlength\fboxsep{0pt}
\setlength\fboxrule{0.5pt}
%caption font size
\captionnamefont{\small}
\captiontitlefont{\small}
%space after figure caption (and other float elements)
\setlength{\belowcaptionskip}{-7pt}

%TABLE
\counterwithout{table}{chapter}

%SOURCE CODE
\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}
\lstset{
extendedchars=true,
captionpos=b,
caption=\footnotesize,
basicstyle=\singlespacing\ttfamily,%\small\fontfamily{"Courier"}\selectfont,
keywordstyle=\color{blue}\bfseries,
commentstyle=\color{purple}\itshape,
identifierstyle=\color{black},
stringstyle=\color{red},
showstringspaces=false,
showspaces=false,
numbers=left,
numberstyle=\footnotesize,
numbersep=9pt,
breaklines=true,
tabsize=2,
showtabs=false,
xleftmargin=1cm
}
\IfLanguageName {finnish} {\renewcommand{\lstlistingname}{Listaus}} {} % what is a good translation for this?
%\counterwithout{lstlisting}{chapter}
%moved after begin document, otherwise does not compile

%% set this format as the default for lstlisting
%\DeclareCaptionFormat{empty}{}
%\captionsetup[lstlisting]{format=empty}

%TOC
%change toc title
\IfLanguageName {finnish} {\addto{\captionsfinnish}{\renewcommand*{\contentsname}{Sisällys}}} {}
%remove dots
\renewcommand*{\cftdotsep}{\cftnodots}
%chapter title and page number not in bold
\renewcommand{\cftchapterfont}{}
\renewcommand{\cftchapterpagefont}{}
%sub section in toc
\setcounter{tocdepth}{2}
%subsection numbered
\setcounter{secnumdepth}{2}
\renewcommand{\tocheadstart}{\vspace*{-15pt}}
\renewcommand{\printtoctitle}[1]{\fontsize{13pt}{13pt}\bfseries #1}
\renewcommand{\aftertoctitle}{\vspace*{-22pt}\afterchaptertitle}
%spacing afer a chapter in toc
\preto\section{%
  \ifnum\value{section}=0\addtocontents{toc}{\vskip9pt}\fi  % original was \vskip11pt
}
%spacing afer a section in toc
\renewcommand{\cftsectionaftersnumb}{\vspace*{-3pt}}
%spacing afer a subsection in toc
\renewcommand{\cftsubsectionaftersnumb}{\vspace*{-1pt}}
%appendix in toc with "Appendix " + num
\IfLanguageName {finnish} {
  \renewcommand*{\cftappendixname}{Liite\space}
  \renewcommand{\appendixtocname}{Liitteet}
}{\renewcommand*{\cftappendixname}{Appendix\space}}
%appendix header
\IfLanguageName {finnish} {\def\appname{Liite\space}}{\def\appname{Appendix\space}}

%TITLES
%chapter title
\titleformat{\chapter}
{\fontsize{13pt}{13pt}\bfseries\linespread{1}}
{\thechapter}{.5cm}{}
\titlespacing*{\chapter}{0pt}{.32cm}{9pt}
\titleformat{\section}
{\fontsize{12pt}{12pt}\linespread{1}}
{\thesection}{.5cm}{}
\titlespacing*{\section}{0pt}{14pt}{6pt}
\titleformat{\subsection}
{\fontsize{12pt}{12pt}\linespread{1}}
{\thesubsection}{.5cm}{}
\titlespacing*{\subsection}{0pt}{14pt}{6pt}


%QUOTE
\renewenvironment{quote}
  {\list{}{\rightmargin=0pt\leftmargin=1cm\topsep=-10pt}%
  \item\relax\fontsize{10pt}{10pt}\singlespacing}
  {\endlist}

%BIBLIOGRAPHY
%bibliography title to be "references"
%if the title don't get renamed properly, move that line after the \begin{document}
\IfLanguageName {finnish} {\addto{\captionsfinnish}{\renewcommand*{\bibname}{Lähteet}}} {\renewcommand\bibname{References}}
\makeatletter %reference list option change
\renewcommand\@biblabel[1]{#1\hspace{1cm}} %from [1] to 1 with 1cm gap
\makeatother %
\setlength{\bibitemsep}{11pt}

%count the appendices (since the chapter counter is reset after \appendix).
%! require to complie 2 times
\regtotcounter{chapter}

%ABBREVIATION AND GLOSSARY
% Generate the glossary
\makeglossaries

%Acronyms, abbreviations, etc. definitions
\newacronym{html}{HTML}{HyperText Markup Language}
\newacronym{sql}{SQL}{Structured Query Language}
\newacronym{io}{I/O}{Input/Output}
\newacronym{ram}{RAM}{Random Access Memory}
\newacronym{php}{PHP}{Hypertext Preprocessor}
\newacronym{lte}{LTE}{Long Term Evolution}
\newacronym{3g}{3G}{Third generation}
\newacronym{ir}{IR}{Infrared}
\newacronym{iot}{IoT}{Internet of Things}
\newacronym{usb}{USB}{Universal Serial Bus}
\newacronym{sim}{SIM}{subscriber identity module}
\newacronym{spi}{SPI}{Serial Peripheral Interface}
\newacronym{api}{API}{Application Program Interface}
\newacronym{otg}{OTG}{USB On-The-Go}
\newacronym{ui}{UI}{User Interface}
\newacronym{http}{HTTP}{Hypertext Transfer Protocol}
\newacronym{https}{HTTPS}{HTTP over SSL}
\newacronym{tcp}{TCP}{Transmission Control Protocol}
\newacronym{udp}{UDP}{User Datagram Protocol}
\newacronym{rtp}{RTP}{Real Time Transport Protocol}
\newacronym{uml}{UML}{Unified Modeling Language}
\newacronym{er}{ER Diagram}{Entity Relationship Diagram}
\newacronym{ws}{Websocket}{Websocket}
\newacronym{paas}{PaaS}{Platform As A Service}
\newacronym{cpu}{CPU}{Central Process Unit}
\newacronym{ssh}{SSH}{Secure Shell}
\newacronym{oop}{OOP}{Object Oriented Programming}
\newacronym{cpp}{C++}{C plus plus}
\newacronym{xml}{XML}{Extensible Markup Language}
\newacronym{ip}{IP}{Internet Protocol}
\newacronym{ran}{RAN}{Radio Access Network}

%Glossary entries
\newglossaryentry{matplotlib}{
	name=Matplotlib, 
	description={Plotting library for Python programming language}
}
\newglossaryentry{qt}{
	name=Qt, 
	description={Cross-platform application framework}
}
\newglossaryentry{labview}{
	name=LabVIEW, 
	description={environment for visual programming language used for instrument control}
}
\newglossaryentry{thesis}{
	name=thesis, 
	description={a written essay one submitted for a university degree},
	plural=theses
}
\newglossaryentry{tcpip}
{
    name=TCP/IP stack,
    description={all the necessary layers to match the conceptual model of the Internet protocol suite}
}
\newglossaryentry{rs232}
{
    name=RS-232,
    description={A standard for serial communications}
}
\newglossaryentry{java}
{
    name=Java,
    description={Programming language able to run on most of the Operative Systems}
}
\newglossaryentry{javame}
{
    name=Java ME,
    description={Java Micro Edition: Java version for mobile or embedded devices}
}
\newglossaryentry{midlet}
{
    name=MIDlet,
    description=A MIDlet is an application that uses the Mobile Information Device Profile (MIDP) on Java ME environment
}
\newglossaryentry{js}
{
    name=Javascript,
    description=Dynamic programming language used mostly in browsers although can be used in desktop and server applications.
}
\newglossaryentry{nodejs}
{
    name=Node.js,
    description={Node.js is an open-source, cross-platform JavaScript runtime environment for developing server-side applications}
}
\newglossaryentry{python}
{
    name=Python,
    description={Dynamic typed interpreted programming language}
}

%----------------------------------------------------------------------------------------
%	TITLE PAGE
%----------------------------------------------------------------------------------------
\makeatletter
\renewcommand{\maketitle}{
\thispagestyle{empty}
\ThisCenterWallPaper{1}{viiva}
%
\vspace*{9.5cm}
\tn{\LARGE\@author\\[22pt]\Huge\IfLanguageName {finnish}{\otsikko}{\@title}\\[22pt]\LARGE\alaotsikko\\[1.75cm]}

\parbox{.7\linewidth}{
\IfLanguageName {finnish}{
  Metropolia Ammattikorkeakoulu\\
  \tutkinto \\
  \kohjelma \\
  \thesis\\
  \pvm
} {
  Helsinki Metropolia University of Applied Sciences\\
  \metropoliadegree \\
  \metropoliadegreeprogramme \\
  \thesis\\
  \specialdate\today % D.M.YYYY date format
}
}
\ThisLRCornerWallPaper{1}{metropolia}
%
\clearpage
}
\makeatother

\makepagestyle{tiivis}
\makeevenhead{tiivis}{}{}{Tiivistelmä}
\makeoddhead{tiivis}{}{}{Tiivistelmä}

\makepagestyle{abstract}
\makeevenhead{abstract}{}{}{Abstract}
\makeoddhead{abstract}{}{}{Abstract}

% BEGIN OF DOCUMENT
\begin{document}
\counterwithout{lstlisting}{chapter}
\lstdefinestyle{styleprogramming}{
	basicstyle=\ttfamily\small\captionsetup{justification=centering},
	commentstyle=\ttfamily\color{violet}
}
%\lstdefinestyle{styleprogrammingcomments}{commmentstyle=\ttfamily\color{violet}}
%\lstdefinestyle{styleprogramming}{basicstyle=\ttfamily\small,numbers=none}

%page number always on the top right, clear the "chapter/section" head
\pagestyle{myheadings}
\markright{}
%clear chapter "title" foot page
\makeevenfoot{plain}{}{}{}
\makeoddfoot{plain}{}{}{}



\maketitle
\newpage

\LRCornerWallPaper{1}{footer}

%----------------------------------------------------------------------------------------
%	ABSTRACT
%----------------------------------------------------------------------------------------

\pagestyle{abstract}
\begin{tabular}{ | p{4,7cm} | p{10,3cm} |}
  \hline
  Author(s) \newline
  Title \newline\newline 
  Number of Pages \newline
  Date
  & 
  \makeatletter
  \@author \newline
  \@title \newline\newline
  \pageref*{LastPage} pages + \total{chapter} appendices \newline %! if no appendices, risk to count total of chapter :D
  \IfLanguageName {finnish} {\foreignlanguage{english}{\longdate\@date}} {\@date}
  \makeatother
  \\ \hline
  Degree & \metropoliadegree
  \\ \hline
  Degree Programme & \metropoliadegreeprogramme
  \\ \hline
  Specialisation option & \metropoliaspecialisation
  \\ \hline
  Instructor(s) & \metropoliainstructors
  \\ \hline
  \multicolumn{2}{|p{15cm}|}{\begin{singlespacing}\vspace{-22pt}
  \paragraph{}	
  In this bachelor's thesis project I develop a communication system for \gls{ir} cameras using \gls{iot} modules to connect them to mobile networks through \gls{lte} hence to Internet, a server-side will receive, analyses and configures ir cameras and send to data to clients
  \paragraph{}
  One of the key points using \gls{ir} cameras is the respect of privacy, Unlike normal cameras generally people cannot be recognized. Applications are related to monitoring of patients: trigger alarm when a patient does not move for a while, control the number of people in a room, etc.
  \paragraph{}
  This project is focused on the technical details of the communication system and implements what was studied on my Innovation Project, specifically analysis techniques that can be done on the server-side.
  
  \end{singlespacing}} \\[14cm] \hline
  Keywords & \metropoliakeywords
  \\ \hline
\end{tabular}
\clearpage

%----------------------------------------------------------------------------------------
%	Acknowledgement ?
%----------------------------------------------------------------------------------------
%\chapter*{Acknowledgement}
%Thanks to my cat
%\clearpage

%----------------------------------------------------------------------------------------
%	TABLE OF CONTENTS
%----------------------------------------------------------------------------------------

\makeevenhead{plain}{}{}{}
\makeoddhead{plain}{}{}{}
\pagestyle{empty} %remove page number in toc (if longer than 2 pages)
\tableofcontents*
\pagestyle{empty} %remove page number in toc (if longer than 1 pages)


\clearpage
%Uncomment this line if you do not have Abbreviations list.
%\pagestyle{plain}

%list of figure, tables comes here...
%\listoffigures
% Sotavalta:Do not include a separate list of tables and/or figures in your thesis.

%----------------------------------------------------------------------------------------
%    Lyhenteet / Abbreviation
%----------------------------------------------------------------------------------------

\begin{singlespacing}

\glsaddall

{
	\titleformat{\section}
	{\fontsize{13pt}{13pt}\bfseries\linespread{1}}
	{\thesection}{.5cm}{}
	%Adapt labelwidth (sorry for the ugly hack)
	\setlist[description]{leftmargin=!, labelwidth=4em}
	\IfLanguageName {finnish} {
		\printacronyms[title=Lyhenteet]
	}{
		\printacronyms[title=Abbreviations]
	}
	\setlist[description]{leftmargin=!, labelwidth=7em}
	\printglossary 
	\setlist[description]{style=standard} % reset settings back to default
}
\end{singlespacing}
%Seems that bug is in sharelatex. Compile fine with TexLive >= 2014


\newpage

%page number always on top right; also for chapter "title" page
\pagestyle{plain}
\makeevenhead{plain}{}{}{\thepage}
\makeoddhead{plain}{}{}{\thepage}

\setcounter{page}{1} %page 1 should be Introduction
\ClearWallPaper
%----------------------------------------------------------------------------------------
%	CONTENT
%----------------------------------------------------------------------------------------

\sloppy % enforce alignment to fully justified

\chapter{Introduction}


Thermal images had a number of advantages over conventional light-based video camera images. These thermal images tell us not only there are living people or animals but also if there is any temperature anomaly on them. They can be used to make assumptions about their physical state using image processing software.

Here is where \gls{iot} comes into play, Nowadays the Internet is very accessible and fast. Almost every conceivable device: phones, watches, televisions, speakers, cameras, etc can be connected, send and receive continuously big amounts of data.

Although with \gls{iot} it comes the inevitable process of define a communication channel between the \gls{iot} devices, visualize, store and distribute data from them. On this paper it is explained the steps of how to develop software solutions to these topics and all the alternatives that were tried, which ones and why were implemented at the end along all the tools and technologies which were used to carry out the project as smoothly as possible.


%% imporve this
Finland is nowadays facing a difficult issue in the area of well-being. The population is aging and the costs in elder health and mental health care are sky-rocketing. This is why health care entities in Finland are looking into decrease their costs by search for new ideas in the field of IT.
This thesis discusses also how \gls{ir} sensors could be exploited in the case company to decrease costs and improving monitoring of patients.

\section{Background of the case company}
The thesis originates in a project I am doing in collaboration with a startup called Levitezer (\url{http://www.levitezer.com/}). A company that develops gimbals and controllers for cameras for image stabilization among other projects \cite{levitezer}.

Even though this is not a health care company, the sensors and methods here explained could be used in Hospitals, sanatoriums, clinics, nursing homes, etc. And right now Levitezer is trying to expand their business to other areas.

The methods and software I developed are being used to create an \gls{api} that connect \gls{ir} sensors together.

\section{Business Challenge}\label{sec:business-challenge}
%% improving costs by not having personal watching people all the time
Find a system which using \gls{ir} sensors allow us to monitoring patients while keeping their privacy along reducing costs by using less staff and improve the service quality, data from those sensors can be accessed from anywhere which make them very versatile and portable.
\section{Objective and Outcome of the Study}
With the business challenge in mind, this study aims to answer the following question:
\begin{displayquote}
{\large  How to create a effective communication channel between ir sensors and clients such as computers, laptops, etc and use it on Well-being services?}
\end{displayquote}

The outcome of this study is a full working communication Chanel using modern cloud technologies, client-side pieces of software able to read sensors; displaying data in form of images while receiving commands to change the sensor behavior, all in bidirectional full duplex communication, proposals to use it on health care institutions and use cases for image analysis
This is an great project as it is a hot topic (\gls{iot} and cloud computing) in the IT world. Methods described on this thesis may help others with their projects.


\chapter{Theoretical Background}
%What is already known about your chosen subject area and what is not known?
%Discuss ideas in previous studies relevant to your topic (a brief introduction to the current state of knowledge and practice in your subject area). Identify a gap in the subject area and justify the purpose of your project, that is, the focus of your topic.

Communications between devices is not a new topic, there are plenty of methods and communications protocols, this can be also part of the problem: there are too many and sometimes this can be overwhelming. In this section what is known about communication and network protocols will be discussed to find the best way to create a communication channel as stated in the business challenge on section~\ref{sec:business-challenge}.


% NetLeap \cite{netleap}

\section{Exchanging data between devices}
% Talk about what is know about communication systems, full stack development, etc
Nowadays there is many ways to communicate between systems but here it will be used web services to achieve communication between sensors and clients. In order to establish a communication between two ends in a computer network or Internet it is important to comprehend how works the "Internet Protocol Architecture" or \gls{tcp}/\gls{ip} stack which is the conceptual model which most of networks are based on~\cite[p.~9]{tcpip}.

	\putimage[5]{tcpip}{\gls{tcp}/\gls{ip} Architecture}

The \gls{tcp}/\gls{ip} stack is build in layers:
\begin{enumerate}
	\item Network Access Layer: physical medium to access the network.
	\item Internet Layer: handles the routing of data
	\item Transport Layer: provides host to host data delivery services.
	\item Application Layer: applications and process that make use of the network
\end{enumerate}
Then, it must be find out a way to communicate through the \gls{tcp}/\gls{ip} stack as shown in figure~\ref{fig:tcpip}.

\section{The medium}
At this point it has to be decided what medium to use to access the network (Network Access Layer in figure~\ref{fig:tcpip}). It could be a simple copper cable, Wi-Fi, microwaves, laser, etc. almost any kind of electromagnetic wave. But since this is an \gls{iot} project the best approach will be using \gls{ran} which are almost everywhere and provide great speeds and bandwidth.

On this project Nokia provided us access to NetLeap which is a \gls{3g} and \gls{lte} network (the same that use mobile phones to connect to Internet). NetLeap is a	test closed network for research~\cite{netleap}.

\section{Network protocols}


\subsection{\gls{udp}}
\subsubsection{The NAT problem}
%% VPN as solution
\subsection{\gls{rtp}}
\subsection{\gls{http}}
\cite{http-rfc}
\subsection{\gls{ws}}
\cite[p.~30]{rfc6455}




\chapter{Methods and Materials}
%How was the project carried out in practice, and how was the data analysed?
%Describe the context in which the work was carried out (such as the overall project and its design, your specific task, work environment) and the workflow. Describe the methods and materials used (accurate details of data, software, materials, methods, techniques). Give a full account of exact test arrangements and measurements carried out, and accurate details of data analysis.
%The issues included in this section depend on the nature of your project. Whatever the issues, describe them in sufficient detail and in logical sequence.

The aim of this project is to design methods to transmit data from one sensor to a client application and vice-versa. Also define a generalization to communicate from $N$ sensors to $M$ client applications, being either $N$ and $M$ arbitrary numbers. Note that the communication must be bidirectional since clients can send commands to sensors to perform operations such as calibration, delay between frames, etc. Then on this communication system there are 3 well differentiated parts:
\begin{itemize}
    \item sensor side: software that connects the sensor with the server side.
    \item server side: software that connects sensors and clients together.
    \item client side: software that connects the an user with the server side to access a sensor.
\end{itemize}

The figure~\ref{fig:communication-channel} shows this idea.

\putimage{communication-channel}{A communication channel}

This chapter will discuss about methods for each side of the communication system in detail.


\section{The sensor}
The \gls{ir} sensor provided by Levitezer delivers all infrared data in form of binary streams trough \gls{usb}.

 In order to make the an image it is necessary to process the those streams. Every image or frame comes in 240 chunks or rows separated by a delimiter of 3 bytes:

\begin{equation}
\label{eq:sensor-stream}
\text {FF FF FF 00} \left\lbrace data \right\rbrace 
\text {FF FF FF 01} \left\lbrace data \right\rbrace 
\text {FF FF FF 02} \left\lbrace data \right\rbrace \dots
\end{equation}



In equation~\ref{eq:sensor-stream} every byte is seen in hexadecimal format containing an sequence "FF FF FF" is the between rows of typically 80 bytes of data. After the sequence, the 4th byte is the number which identify the row.

As equation~\ref{eq:metadata-row} shows, The 240th (F0 in hexadecimal) and last row provides meta-data about the frame

\begin{equation}
\label{eq:metadata-row}
\dots \text {FF FF FF F0} \left\lbrace metadata \right\rbrace
\end{equation}
In table~\ref{table:metadata-row} are listed all information contained in the meta-data taking as byte '0' the one after the sequence "FF FF FF F0"

\subsubsection{Meta-Data}
\begin{table}[h]
    \centering
    \begin{tabu}{| l | c |}
        \hline
        \rowfont[c]{\bfseries} Meta-Data Parameter & Bytes (from 0 to 80) \\ \hline

        Time counter & 4,3,1,0 \\
        Frame counter & 10,9,7,6 \\
        Frame Mean & 13,12 \\
        Sensor temperature & 16,15 \\
        Maximum temperature & 19,18 \\
        Minimum temperature & 22,21 \\
        Discarded packets count & 25,24 \\
        Maximum temperature limit & 28,27 \\
        Minimum temperature limit & 31,30 \\
        AGC byte & 34 \\
        Bit depth & 35 \\
        Delay between frames & 37,36 \\
        \hline
    \end{tabu}
    \caption{Meta-data and its position in the row}
    \label{table:metadata-row}
\end{table}

Here is a short explanation about the meta-data values:
\begin{itemize}
    \item Time counter: Amount of seconds since the sensor was power on.
    \item Frame counter: Amount of frames since the sensor was power on.
    \item Frame mean:
    \item Sensor temperature: temperature of the sensor itself.
    \item Maximum temperature: maximum temperature registered the current frame.
    \item Minimum temperature: minimum temperature registered the current frame.
    \item Discarded packets: packets that were not read. a great number may tell that the application is not reading the sensor fast enough.
    \item Maximum temperature limit: The limit set with the command for maximum limit.
    \item Minimum temperature limit: same that previous but with minimum temperature.
    \item AGC byte: tell if the limits are set or not (useful for implementing indicators).
    \item Bit depth: bit depth of the image, it can be 0, 2 or 8 (default).
    \item Delay between frames: if no delay is set (delay=0) then the delay is about 111 milliseconds (9 frames per second).
\end{itemize}

\subsubsection{Commands}
% TODO: more Pictures of the sensors
The commands are sent over the same serial \gls{usb} cable from which the frames are received.

\begin{table}[h]
    \centering
    \begin{tabu}{| l | c | c |}
        \hline
        \rowfont[c]{\bfseries} Command Name & Command (ASCII byte) & Arguments \\ \hline
        
       Synchronize 		    & S & No      \\
       Calibrate   		    & C & No      \\
       Set Max Limit        & H & 2 bytes \\
       Set Min Limit        & L & 2 bytes \\
       Auto Max Limit       & A & No	  \\
       Auto Min Limit       & a & No	  \\
       Set Bit Depth        & B & 1 byte  \\
       Set Frame Delay      & U & 2 bytes \\

        \hline
    \end{tabu}
    \caption{Commands accepted by the sensor}
    \label{table:commands}
\end{table}

The frame-rate is 9 frames per second at maximum, although the sensor can be configured with an arbitrary delay time between frames.

\subsubsection{Creating the image}
Every frame has a size of 160x120, but the image data comes in a matrix of 80x239 (240 is the meta-data row) as equation~\ref{eq:sensor-stream} and \ref{eq:metadata-row} shown before. Each byte of data can be seen as a pixel in a gray-scale image, but in order to generate the correct image the "data matrix" must be reshaped to 160x120 as show in the figure~\ref{fig:sensor-image}. Every 2 row in the data matrix make 1 row in the image.
\putimage{sensor-image}{Reshaping data}

I developed a simple solution to do this:

For each data row (equation~\ref{eq:data}) let $n_j$ be the data current row number performing by the 4th byte in equation~\ref{eq:sensor-stream}, then for every $d_i$ value in the data row is possible to define every pixel $p_{ij}$ of the image matrix (equation~\ref{eq:image}) as a coordinate pair $(x,y)$ in the data matrix 
\begin{equation}
\label{eq:data}
D_{i,j} = 
\begin{pmatrix}
n_1 & d_1 & d_2 & d_3 & \cdots & d_i\\
n_2 & d_1 & d_2 & d_3 & \cdots & d_i\\
\vdots & \vdots & \vdots& \vdots  & \ddots & \vdots  \\
n_j & d_1 & d_2 & d_3 & \cdots & d_i\\
\end{pmatrix}
\end{equation}

\begin{equation}
\label{eq:image}
I_{i,j} = 
\begin{pmatrix}
    p_{1,1} & p_{1,2} & \cdots & p_{1,j} \\
    p_{2,1} & p_{2,2} & \cdots & p_{2,j} \\
    \vdots  & \vdots  & \ddots & \vdots  \\
    p_{i,1} & p_{i,2} & \cdots & p_{i,j} 
\end{pmatrix}
\end{equation}

\begin{equation}
\label{eq:coordinate}
x = n_j \backslash 2  \qquad y = n_j \bmod 80 + i
\end{equation}

\begin{equation}
\label{eq:pixel}
p_{ij} = d_{xy}
\end{equation}

As seen in equation~\ref{eq:pixel} any pixel value corresponds to a x,y pair define in equation~\ref{eq:coordinate} .

Note the "\textbackslash" here is meant for integer division in equation~\ref{eq:coordinate}, it is \textbf{not} a normal division with rational or decimal numbers.

As an example of a practical implementation in \gls{python} see the listing~\ref{listing:image-python} which function process{\_}data{\_}row is called for every data row

\putcode{image-python}{Simplified example of creating a frame in Python}[language=Python,style=styleprogramming]$
self.frame_arr[f_row][f_col]

def process_data_row(self, row):
    n_row = row[0]
    
    for indx, val in enumerate(row[1:]):
        f_row = (n_row)/2
        f_col = (n_row) % 2 * 80 + indx
        self.frame_arr[f_row][f_col] = val
$ 

Also note that in order to fill the "self.frame{\_}arr" matrix the function is must be called 239 times

\section{Sensor Reader Methods}
The sensor has been described in the previous section. Here different methods to read the sensor are discussed, some worked better than others, nevertheless all of what was tried is included.

\subsection{Android smart-phone as Gateway}
Most of Android smart-phones have an \gls{otg} which allows to use \gls{usb} peripherals in the phone with the correspondent \gls{otg} adapter This can be used to develop an Android application to receive the data from the sensor and send it through Internet using any protocol, in this sense the cellphone act as a gateway to Internet, letting the sensor access the \gls{3g} or the \gls{lte} network.

\putimage{android_otg}{Android smart-phone and sensor}

An advantage of this approach is that the smart-phone(including a \gls{sim} card) has all the hardware on it to make the communication. Hence there is only need to focus on the software part.

This was tested using a \gls{php} file in a server on Metropolia UAS alongside an Android Application I developed to send all the data from the sensor to server.

Note that this method requires  a terminal which supports \gls{usb} \gls{otg}.

\subsubsection{Description of the Android Application}
To create the Android application it is needed some things:
\begin{itemize}
	\item A minimal \gls{ui}
	\item A network protocol and its implementation
	\item A background process
\end{itemize}

The \gls{ui} let us start the reading and provide an address and a port to connect. See figure~\ref{fig:android-screenshot}.
\putimage[5]{android-screenshot}{\gls{ui} of the Android Application}


As network protocol \gls{http} was chosen, although it is not the best for continuously sending data. Then an \gls{php} script processed the request and store the data in form of hexadecimal strings in a file as listing~\ref{listing:php-script} illustrates

% more options for code https://www.sharelatex.com/learn/Code_listing#/Options_to_customize_code_listing_styles
\putcode{php-script}{PHP code in the server side}[language=PHP,style=styleprogramming]^
<?php
$data = "";
// get data only from post request
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $data = ($_POST["data"]);
}
// write it to file
$fileName = "data.txt";
$file = fopen($fileName, "a");
if($file){
    fwrite($file, formatData($data).",");
    fclose($file);
    echo "OK";
}

function formatData($data){
    $arr = unpack('H*', $data);
    return strtoupper(implode(" ", $arr));
}
?>
^ %$ this is to fix the color in Texstudio, ^ is the delimiter


Then using an Android service to keep reading in the background which is the usual approach to deal with long running operations on Android Applications~\cite{android-services}.

The usb-serial-for-android library provides all the necessary to read data from the mini-usb port~\cite{usb-serial-for-android}. The listing~\ref{listing:android_gateway} shows an extract of my code implementing the callback to receive data in directly from the \gls{usb} port.

\putcode{android_gateway}{Android: Callback to receive data from sensor}[language=Java,style=styleprogramming]^
// the parameter data is a binary string from the sensor
@Override
public void onNewData(final byte[] data) {
    if(bufferFrames.isFull()){
        callback.getBuffer(bufferFrames);
        bufferFrames = new BufferFrames();
    }else{
        bufferFrames.addChunk(new Chunk(data));
    }
}
^
% end of code, delimiter is ^
Notice in line 3 that it is in reality quite simple to receive binary data in form of an byte array.


\subsection{Lte module}
\gls{lte} modules work as a phone: They need a \gls{sim} card to connect to network, they can be integrated in a board. Typically these modules have a number of interfaces such as \gls{usb}, rs-232, \gls{spi}, etc to connect peripherals.


In order to set a route between your device and a service on Internet or your own server, a piece of code must be provided, it depends on the module how can be done. For a project like this it is interesting that the module has its own \gls{tcpip}.



\subsubsection{Gemalto Lte module}


This is not a simple modem that allows other machines to be connected to Internet, it has a complete \gls{tcpip} which means that protocols of the transport layer such as \gls{tcp} and \gls{udp} and application layer such as \gls{http} and \gls{https} can be used as well all in very small compact chip as it is seen in figure~\ref{fig:lte_module}.

	\putimage[5]{lte_module}{ELS61-E chip size}

The module used was Gemalto ELS61-E which is configured using the Hayes command set (also called AT commands) which are used typically on modems %reference%.
\putcode{at_commands_example}{AT commands}[style=styleprogramming]$
AT^SMSO  # shutdown
AT+COPS  # register to network command
$ % end of code, delimiter is $


This module can be programmed using \gls{javame} which is a \gls{java} edition for embedded devices \cite{javame}. Application layer protocols and \gls{tcp}/\gls{udp} sockets can be used in a \gls{midlet} which allows to describe the life-cycle of a single application. With this tools the \gls{usb}, \gls{spi} or \gls{rs232} ports can be controlled and even send AT commands.


\putcode{midlet-example}{MIDlet application life-cycle example}[language=Java,style=styleprogramming]^
import javax.microedition.midlet.*;

public class HelloWorld extends MIDlet {
    
    public HelloWorld() {
        System.out.println("Constructor");
    }
    
    /** This is the main application entry point. */
    public void startApp() throws MIDletStateChangeException {
        System.out.println("startApp");
        System.out.println("\nHello World\n");
        destroyApp(true);
    }
    
    /**  Called when the application has to be temporary paused. */
    public void pauseApp() {
        System.out.println("pauseApp()");
    }
    
    /** Here you must clean up everything not handled by the garbage collector. */
    public void destroyApp(boolean cond) {
        System.out.println("destroyApp(" + cond + ")");
        notifyDestroyed();
    }
}
^ % end of code delimeter is ^


For a full list of features of the module refer to \url{http://www.gemalto.com/brochures-site/download-site/Documents/M2M_ELS61_datasheet.pdf}


	\putimage{lte_board}{Lte Module on top of the board to program it}
To do all the communication and configuration with the module there is a board where it can be attached proving micro-usb connectors, antenna, reset button, power among other things see figure~\ref{fig:lte_board}





\subsection{Raspberry Pi}
A Raspberry pi is a credit card sized computer and on its model 3B includes among other things 4 \gls{usb} ports multi-core \gls{cpu}~\cite{rpi3}. Considering that the raspberry comes with a Linux distribution the possibilities are unlimited, for the purposes of this project it is specially handy the possibility of using any programming language and a lot of software packets available.

\putimage{raspberry}{Raspberry Pi Physical appearance}

\subsubsection{The reader program}
The programming language chosen to communicate with the sensor from the raspberry pi was \gls{python} since it has a number of libraries available to use. Then it is necessary to point what features are suitable for a program which reads the sensor and open a connection to the server side:
\begin{itemize}
    \item Needs to communicate both ways trough \gls{usb}.
    \item Has to open a connection to the server/cloud continuously and be able to recover. automatically from failures on the network.
    \item Must do all this at same time taking advance of raspberry pi's multiple cores.
    \item Prioritize the sensor read task over the rest, this is the most critical part and must be have a higher priority

    
\end{itemize}

In order to separate tasks it is possible to use multiple threads which are supported in \gls{python} and the multiprocessing package to have separate into several process and take advantage of the various \gls{cpu} cores~\cite{python-multi}. For controlling the priority the package "psutil" allow to control the "niceness" of the process~\cite{python-psutil}

It is also desirable being able to do certain operations remotely without using \gls{ssh}. The connection made between client-server-raspberry can be taken in advance to for example shutdown, reset, update, etc the raspberry. For this purpose the subprocess package can be use to issue commands and other process, as one can do in a terminal shell~\cite{python-subprocess}. See the listing~\ref{listing:rpi-subprocess} to see my actual implementation.

\section{Client Application Methods}
On this section it will be described different methods to create a client able to connect to the cloud thus the sensor, present the data to the user and send commands to the sensor.

\subsubsection{Reversing engineering a \gls{labview} Application}
At the beginning of the project Levitazer provided an example application to read the sensor from a laptop made in \gls{labview}, although this works it is not an idea platform to develop since it is strict closed software and in order to work with it a expensive license has to be paid. Then it was agreed that I will make an reverse-enginered python version out of the \gls{labview} client and extends its capabilities beyond the the simple laptop-sensor connection.

    \putimage{labview}{LabView implementation}
    
\gls{labview} programs are not write in code but using a "visual programming language" based in diagrams similar to circuits were the data flows. It is oriented to instrument control, data acquisition, automation, etc.~\cite{labview}

Although there was not intention to use \gls{labview} for the purposes of this thesis, it does was used to do research about what protocols to use and testing, see figure~\ref{fig:labview-udp} for a simple \gls{udp} client applications which just receives raw binary information from a sensor and displays it alongside the frame number.

    \putimage{labview-udp}{Labview UDP client}

%\subsection{\gls{udp} Java client}
\subsection{Websocket Python Client}
This application was intended to have the characteristics of the \gls{labview}'s mentioned on the previous section and provide it with connectivity to a cloud \gls{paas} for remote communication. The application was wrote on python and taking advantage of the multiple libraries that the community offers for free as open source. % TODO: citation required?

\putimage{python-client}{Python Client Application}

\subsubsection{Design}
On a relatively complex application as this one  \gls{oop} is the most convenient way to go when designing the application

    \putimage{python-uml}{UML diagram (simplified)}
    
As seen in figure~\ref{python-uml} it shows the most important components of the application and its relations, it can be noticed that there is a separation between \gls{ui} components and logical ones.

\subsubsection{User Interface}
The user interface is implemented using the known \gls{qt} framework which is uses \gls{cpp} but there is a python bindings package to use in a python application without writing a single line of \gls{cpp} code. % TODO: citation

Advantages of using qt are among others:
\begin{itemize}
    \item cross-platform: same code works on any operative system where the framework is available.
    \item it is possible to design the interface using a designer program (see figure~\ref{fig:qt-designer}) and save it as a \gls{xml} file that can be read from the application, saving a lot of time on development stage.
    \item it is a well known framework and there is plenty of information available about it.
\end{itemize}

\putimage{qt-designer}{QT designer}

The sensor image itself is made using a plotting library named \gls{matplotlib} used in quality scientific plots and animations. \gls{matplotlib}  also provides a back-end to attach the graphics to \gls{qt} among other \gls{ui} frameworks.

\subsubsection{Logic}



\subsection{Android Client}

    \putimage[4]{android-client}{Android Client}
    \putimage[4]{android-client2}{Android Client}

\section{Server Side Methods}
\subsection{Communication sensor-client}
	\putimage{communication_udp}{Diagram of the communication using the module and UDP}
\subsection{Python Flask}
\subsection{Node js Server Application}
\subsubsection{Unit Testing}
\subsubsection{Acceptance Testing: Robot Framework}

\section{Cloud \gls{paas} methods}
\subsection{Google Cloud}
\subsection{Open Shift and Docker}
% url hooks to update

\section{Other Tools used}
\subsection{Control Version}
% show repository in gitgub
% url hooks to update
%image of the git branches
GitHub
\subsection{Using Latex as edition tool}
% What is latex, what is tex
% reasons to use latex, abreviations, commands etc, show figures
Latex

\chapter{Results}
%What was found/created/designed/produced?

\section{Discarded Methods}
\subsection{android smart-phone gateway solution}
This method was purely to test the sensors and to seek for a suitable network protocol rather than as a serious solution for the purposes of this thesis, nevertheless the outcomes were satisfactory and opened the door to a deeper understanding on how \gls{usb} communication can work using a High level language as \gls{java}.
\subsection{\gls{lte} module solution}

\section{The communication channel}
Sections 3.4 and 3.5 discuss where the channel logic is (aka the cloud) and what kind of application and technology could be used. Regardless what technology it is used for coding, build and maintain the cloud application, and before start coding it should define how different components are related between each other.
Let’s start by defining the following entities:
\begin{itemize}
    \item Sensor: It represents a single sensor connected to a raspberry pi, although it could a normal computer. The sensor itself does not connect to networks, thus it needs a middle hardware but it is considered as whole “entity” here.
    \item Client: A client can be anything that can connect to a sensor by \gls{http} request. A desktop computer, a smart-phone, etc. The client must create frames from sensor and send commands using a \gls{ws}.
    \item Cloud: It is what holds all the sensor entities and their clients on it.
    The channel should support an unlimited number of sensors which can hold an unlimited number of clients.
\end{itemize}
\putimage[15]{channel-er}{ER diagram}
The channel should support an unlimited number of sensors which can hold an unlimited number of clients.
The diagram in figure \ref{fig:channel-er} represents the general view of how entities are related to each other. This helps to develop a \gls{uml} Class Diagram which specifies how classes in an Object Orient Programming language are related to each other. In figure~\ref{fig:channel-uml} there is such diagram simplified.
On the final implementation the server side application was written in \gls{js} which is the Language for \gls{nodejs} applications.
\putimage[15]{channel-uml}{\gls{uml} diagram}

\section{Sensor Reader Application}

\section{Client Applications}
\subsection{Python Desktop Application}
\subsection{Android Smart-phone Application}



\chapter{Discussion}
%What do the results mean?
\section{Use in Well-being environments}
\section{Possible changes in the future}
\subsection{3D \gls{ir} map using multiple sensors}
\subsection{gls{html}5 application}
\subsection{Using RTP to broadcast video to clients}


\chapter{Conclusions}
\section{Technologies chosen and why}
\section{What have I learned}

\chapter{Acknowledgments}
I want to thank to... 



%----------------------------------------------------------------------------------------
%   BIBLIOGRAPHY 
%----------------------------------------------------------------------------------------

\IfLanguageName{finnish}{\bibliographystyle{vancouver_fi}}{\bibliographystyle{vancouver}}
%line space
%\singlespacing %removed otherwise the appendix are also single space
\begin{flushleft}
\begin{singlespacing}
\bibliography{biblio}
\end{singlespacing}
\end{flushleft}

%for conting the pages
\label{LastPage}~


%----------------------------------------------------------------------------------------
%   APPENDICES 
%----------------------------------------------------------------------------------------
%avoid that the last page of bib get appendix header
\clearpage
%start appendix
\appendix
%no page number for appendix in table of content
\addtocontents{toc}{\cftpagenumbersoff{chapter}}
%appendix sections and subsections not in table of content
\settocdepth{chapter}
%add "Appendices" in the table of content
\addappheadtotoc
%force smaller vertical spacing in table of content
%!!! There can be some fun depending if the appendices have (sub)sections or not :D
% You will have to play with these numbers and eventually copy the \pretocmd line on before some \chapter and force another number.
\addtocontents{toc}{\vspace{11pt}}
\pretocmd{\chapter}{\addtocontents{toc}{\protect\vspace{-24pt}}}{}{}
%have Appendix 1 (instead of Appendix A)
\renewcommand{\thechapter}{\arabic{chapter}} 

\newcommand\liite[1]{
%each appendix restart page num to one
\setcounter{page}{1}
%special counter for appendix TODO: this is a ugly quick hack :( Should find a better way to count the page per appendix.
\newtotcounter{appx#1}
%overwrite the header
\makeevenhead{plain}{}{}{\appname \thechapter \\ \thepage\,(\stepcounter{appx#1}\total{appx#1})}
\makeoddhead{plain}{}{}{\appname \thechapter \\ \thepage\,(\stepcounter{appx#1}\total{appx#1})}}

\liite{1}
\chapter{LTE module}\label{appx:first}
% Note that every appendix will be a chapter.
% Sorry for the ugly hack on how to count the total pages per appendix.
% Of course with section and subsection.
% And you can cite \cite{tobias:book} stuff, it will go into the main bibliography.

\section{Configuration}
\putcode{configure_at_commands}{Configure and test an Internet connection}[style=styleprogramming]$
//configure internet profile
AT^sics?^ 
AT^SICS=0,"conType","GPRS0"
AT^SICS=0,"apn","otaniemi"
AT^SICS=0,"inactTO", "20"
AT^SICS=0,dns1,"8.8.8.8"
AT^SICS=0,passwd,""
AT^SICS=0,user,""

//configure internet service
AT^SISS=0,srvType,"Socket"
at^siss=0,conId,0
at^siss=0,address,"socketcp://8.8.8.8:80"

// check internet
AT^SICI?

// make a ping to google
AT^SISX="Ping",0,"8.8.8.8"
$



\clearpage % avoid that the last page of previous appendix get this header
\liite{2}



\chapter{Sensor reader listings}\label{appx:second}
\addtocontents{toc}{\vspace{11pt}}

\begin{lstlisting}[label={listing:serial-reader},caption={Serial Reader Class},language=Python, style=styleprogramming]
import thread
import logging
import psutil
from multiprocessing import Process
from serial import Serial, SerialException
from Constants import VERY_HIGH_PRIORITY, HIGH_PRIORITY

class Serial_reader(Serial):
"""" This class read data from sensor in a Thread """
    def __init__(self, pipe, port):
        Serial.__init__(self, port=port, baudrate=115200)
        self.pipe = pipe
        self._start_process()
    
    def _start_process(self):
        process = Process(name="SerialProcess", target=self._run, args=())
        process.daemon = True
        process.start()
        try:
            psutil.Process(process.pid).nice(VERY_HIGH_PRIORITY)
        except psutil.AccessDenied as e:
            psutil.Process(process.pid).nice(HIGH_PRIORITY)
    
    def _get_data(self):
        one_byte = self.read(1)
        n_bytes = self.in_waiting
        return one_byte + self.read(n_bytes)
    
    def _send_data(self):
        while self.is_open:
            print "waiting for commands"
            data = self.pipe.recv()
            print data
            self.write(data)
    
    def _run(self):
        thread.start_new_thread(self._send_data, ())
        while self.is_open:
            try:
                data = self._get_data()
                self.pipe.send(data)
            except SerialException as e:
                logging.error(e.message)
                self.stop()
                break
    
    def stop(self):
        if self.is_open:
        self.close()

\end{lstlisting}\vspace{14pt}

\begin{lstlisting}[label={listing:rpi-ws},caption={Websocket Class},language=Python, style=styleprogramming]
import logging
import thread
from websocket import WebSocketApp, ABNF
from Constants import URL, CAMERA_PATH, PARAMETERS

class WebSocketConnection(WebSocketApp):
    def __init__(self, pipe, url=URL + CAMERA_PATH + PARAMETERS):
    WebSocketApp.__init__(self, url,
    on_message=self.on_message,
    on_error=self.on_error,
    on_close=self.on_close,
    on_open=self.on_open)
    self.open_connection = False
    self.pipe = pipe
    
    def on_message(self, ws, message):
        logging.warn("received command:%s, %d bytes", message[0], len(message))
        self.pipe.send(message)
    
    def on_error(self, ws, error):
        logging.error(error)
    
    def on_close(self, ws):
        self.open_connection = False
        logging.warn("### closed ###")
    
    def on_open(self, ws):
        self.open_connection = True
        logging.warn("opened new socket")
    
        def run():
            while (self.open_connection == True):
                data = self.pipe.recv()
                self.send_data(data)
        
        thread.start_new_thread(run, ())
    
    def stop(self):
        self.open_connection = False
    
    def send_data(self, data):
        if self.open_connection and len(data) != 0:
        self.send(data, opcode=ABNF.OPCODE_BINARY)
        
    def set_pipe(self, pipe):
        self.pipe = pipe
\end{lstlisting}\vspace{14pt}

\begin{lstlisting}[label={listing:rpi-subprocess},caption={Subprocess example},language=Python, style=styleprogramming]
from thread import start_new_thread
from subprocess32 import call
import logging

def shutdown():
    run_command_async("/sbin/poweroff")

def reboot():
    run_command_async("/sbin/reboot")

def update():
    run_command_async("./build.sh")

def test():
    run_command_async("sleep", "3")

commands = {
'rs': shutdown,
'rr': reboot,
'ru': update
}

def run_command_async(*args):
    def run(*args):
        result = call(args)
    
    start_new_thread(run, args)


def is_raspberry_command(s):
""" Check this is a command for the raspberry rather than the sensor. First letter must be an 'r'"""
    if s[0] == 'r':
        command = commands.get(s)
        if callable(command):
            command()
        else:
            logging.warn("command not found: %s" % s)
            return True
    else:
        return False



\end{lstlisting}\vspace{14pt}


\clearpage
\liite{3}
\end{document}
